name: Trigger deploy Nogin API [DEV]

on:
  workflow_dispatch:
    inputs:
      target-branch:
        description: 'Target branch to deploy deploy-dev'
        required: true
        default: 'test-trigger-deploy' 

jobs:
  rebase-and-push:
    name: Rebase and Deploy
    runs-on: ubuntu-latest

    steps:
      # Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v3

      # Checkout the `test-workflow` branch and pull the latest changes
      - name: Checkout and Pull Dev Branch
        run: |
          git fetch 
          git checkout test-workflow
          git pull origin test-workflow

      # Checkout the target branch deploy-dev, pull, and rebase on `test-workflow`
      - name: Checkout and Rebase Target Branch
        run: |
          set -x  # Enable command tracing
          git config --global user.email "royjimval@gmail.com"
          git config --global user.name "RoyJimenezValdez"
          git status
          git fetch 
          git branch 
          git checkout ${{ github.event.inputs.target-branch }}
          git pull origin ${{ github.event.inputs.target-branch }}
          git branch 
          git rebase --reapply-cherry-picks test-workflow || (
            git rebase --abort &&
            echo "Conflict detected. Attempting conflict resolution." &&
            git rebase --strategy-option=theirs test-workflow
          )

      # Log the changes for confirmation
      - name: Show Git Log
        run: git log --oneline -n 10

      # Push the rebased branch back to the remote
      - name: Push Rebases to Target Branch
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git push --force-with-lease origin ${{ github.event.inputs.target-branch }}

      # Notify the action is done
      - name: Complete
        run: echo "Rebase and deployment process started successfully!"
